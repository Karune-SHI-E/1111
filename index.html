<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>压缩包密码查询</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #121212; color: #e0e0e0; }
input, button { padding: 8px; margin: 5px 0; font-size: 16px; }
button { cursor: pointer; }
#result { margin-top: 15px; }
</style>
</head>
<body>
<h2>🔑 压缩包密码查询</h2>
<input type="text" id="md5-input" placeholder="输入文件 MD5" size="35"/>
<button id="query-btn">查询密码</button>
<div id="result"></div>

<script>
const MD5_REGEX = /^[a-fA-F0-9]{32}$/;
const queryBtn = document.getElementById('query-btn');
const md5Input = document.getElementById('md5-input');
const resultDiv = document.getElementById('result');

// GitHub raw URL
const GITHUB_URL = 'https://raw.githubusercontent.com/Karune-SHI-E/1111/master/passwords_local.json.gz';
// 自建服务器 URL（回退用）
const SERVER_URL = 'http://127.0.0.1:5000'; // 替换为公网可访问地址

queryBtn.addEventListener('click', async () => {
    const md5 = md5Input.value.trim();
    if (!MD5_REGEX.test(md5)) {
        resultDiv.textContent = "❌ MD5格式不正确";
        return;
    }

    resultDiv.textContent = "🔍 查询中...";

    try {
        let password = null;

        // ---------------- GitHub 查询 ----------------
        try {
            // 如果 raw 被 CORS 限制，可使用简单代理（可选）
            // const resp = await fetch('https://cors-anywhere.herokuapp.com/' + GITHUB_URL);
            const resp = await fetch(GITHUB_URL);
            if (resp.ok) {
                const compressed = await resp.arrayBuffer();
                const decompressed = pako.inflate(new Uint8Array(compressed), { to: 'string' });
                const data = JSON.parse(decompressed);

                // data 是数组 [[md5, password], ...]
                const entry = data.find(e => e[0].toLowerCase() === md5.toLowerCase());
                if (entry) password = entry[1];
            }
        } catch (e) {
            console.warn("GitHub 查询失败，尝试服务器回退", e);
        }

        // ---------------- 服务器查询 ----------------
        if (!password) {
            try {
                const resp2 = await fetch(`${SERVER_URL}/query/${md5}?user_id=YOUR_ID`);
                if (resp2.ok) {
                    const j = await resp2.json();
                    if (j.password) password = j.password;
                }
            } catch (e) {
                console.warn("服务器查询失败", e);
            }
        }

        // ---------------- 结果显示 ----------------
        if (password) {
            resultDiv.textContent = `🔑 密码: ${password}`;
        } else {
            resultDiv.textContent = "❌ 未找到密码";
        }

    } catch (e) {
        console.error(e);
        resultDiv.textContent = "❌ 查询失败，请检查网络";
    }
});
</script>
</body>
</html>
